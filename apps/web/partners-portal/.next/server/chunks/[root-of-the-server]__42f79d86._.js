module.exports=[66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},4287,e=>{"use strict";e.i(89161),e.i(81769),e.i(31967),e.s([])},6898,e=>{"use strict";var t=e.i(89161);async function r(e){let r=await t.redis.hgetall(`learning_profile:${e}`);if(!r||!("userId"in r))return null;let n={...r};return"string"==typeof n.completedCourses&&(n.completedCourses=JSON.parse(n.completedCourses||"[]")),"string"==typeof n.strugglingTopics&&(n.strugglingTopics=JSON.parse(n.strugglingTopics||"[]")),"string"==typeof n.strongTopics&&(n.strongTopics=JSON.parse(n.strongTopics||"[]")),"string"==typeof n.questionsAsked&&(n.questionsAsked=JSON.parse(n.questionsAsked||"[]")),"string"==typeof n.recommendedNextTopics&&(n.recommendedNextTopics=JSON.parse(n.recommendedNextTopics||"[]")),n}async function n(e){let r=new Date().toISOString(),n={userId:e,completedCourses:[],skillLevel:"beginner",preferredPace:"normal",learningStyle:"mixed",strugglingTopics:[],strongTopics:[],questionsAsked:[],recommendedNextTopics:[],conversationCount:0,lastActiveAt:r};return await t.redis.hset(`learning_profile:${e}`,{userId:e,completedCourses:JSON.stringify(n.completedCourses),skillLevel:n.skillLevel,preferredPace:n.preferredPace,learningStyle:n.learningStyle,strugglingTopics:JSON.stringify(n.strugglingTopics),strongTopics:JSON.stringify(n.strongTopics),questionsAsked:JSON.stringify(n.questionsAsked),recommendedNextTopics:JSON.stringify(n.recommendedNextTopics),conversationCount:0,lastActiveAt:r}),n}async function s(e,s){let a={...{...await r(e)||await n(e),...s,lastActiveAt:new Date().toISOString()}};Array.isArray(a.completedCourses)&&(a.completedCourses=JSON.stringify(a.completedCourses)),Array.isArray(a.strugglingTopics)&&(a.strugglingTopics=JSON.stringify(a.strugglingTopics)),Array.isArray(a.strongTopics)&&(a.strongTopics=JSON.stringify(a.strongTopics)),Array.isArray(a.questionsAsked)&&(a.questionsAsked=JSON.stringify(a.questionsAsked)),Array.isArray(a.recommendedNextTopics)&&(a.recommendedNextTopics=JSON.stringify(a.recommendedNextTopics)),await t.redis.hset(`learning_profile:${e}`,a)}async function a(e){let r=await t.redis.hgetall(`tutor_conv:${e}`);if(!r||!("id"in r))return null;let n={...r};return"string"==typeof n.messages&&(n.messages=JSON.parse(n.messages||"[]")),"string"==typeof n.learningProfile&&(n.learningProfile=JSON.parse(n.learningProfile)),"string"==typeof n.isActive&&(n.isActive="1"===n.isActive||"true"===n.isActive),n}async function i(e,s){let a=`tutor_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=new Date().toISOString(),o=await r(e)||await n(e);return await t.redis.hset(`tutor_conv:${a}`,{id:a,userId:e,courseId:s||"",messages:JSON.stringify([]),learningProfile:JSON.stringify(o),createdAt:i,updatedAt:i,isActive:1}),await t.redis.sadd(`user:${e}:tutor_convs`,a),{id:a,userId:e,courseId:s,messages:[],learningProfile:o,createdAt:i,updatedAt:i,isActive:!0}}async function o(e,r){let n=await a(e);if(!n)throw Error("Conversation not found");n.messages.push(r),n.updatedAt=new Date().toISOString(),await t.redis.hset(`tutor_conv:${e}`,{messages:JSON.stringify(n.messages),updatedAt:n.updatedAt})}async function l(e,r=10){let n=await t.redis.smembers(`user:${e}:tutor_convs`);return n.length?(await Promise.all(n.map(e=>a(e)))).filter(e=>null!==e).sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime()).slice(0,r):[]}async function c(e){let r=await t.redis.smembers(`user:${e}:recommendations`);return r.length?(await Promise.all(r.map(async e=>await t.redis.hgetall(`recommendation:${e}`)))).filter(e=>!!e):[]}async function d(e){let t=await r(e);if(!t)return{conversationCount:0,totalMessagesExchanged:0,averageMessagesPerConversation:0,topicsCovered:[],lastActive:new Date().toISOString()};let n=await l(e),s=n.reduce((e,t)=>e+t.messages.length,0),a=n.length>0?Math.round(s/n.length):0;return{conversationCount:t.conversationCount,totalMessagesExchanged:s,averageMessagesPerConversation:a,topicsCovered:[...t.strongTopics,...t.strugglingTopics],lastActive:t.lastActiveAt}}e.s(["addMessageToConversation",()=>o,"createLearningProfile",()=>n,"createTutorConversation",()=>i,"getLearningProfile",()=>r,"getTutorAnalytics",()=>d,"getTutorConversation",()=>a,"getUserConversations",()=>l,"getUserRecommendations",()=>c,"updateLearningProfile",()=>s])},76153,e=>{"use strict";var t=e.i(72305),r=e.i(89013),n=e.i(88387),s=e.i(77950),a=e.i(30739),i=e.i(43703),o=e.i(58601),l=e.i(59251),c=e.i(12242),d=e.i(6002),u=e.i(92234),p=e.i(45043),g=e.i(18348),m=e.i(85936),f=e.i(72254),v=e.i(93695);e.i(24887);var h=e.i(42277),y=e.i(34550);e.i(21534);var w=e.i(52945),x=e.i(6898);e.i(70414);var S=e.i(26783);async function T(e,t,r,n,s){let a;return a=0===r.length?"greeting":r.length<5?"teaching":r.length%10==0?"assessment":r.length>20?"recommendation":"teaching",{userId:e,courseId:t,previousMessages:r,learningProfile:n,currentTopic:s,conversationPhase:a}}async function A(e,t,r){if(!S.anthropic)throw Error("Anthropic API key is not configured");let n=function(e){let{learningProfile:t,currentTopic:r}=e,n=t.strugglingTopics.slice(0,3).join(", ")||"none identified yet",s=t.strongTopics.slice(0,3).join(", ")||"general concepts";return`You are a personalized AI tutor for SovraGov platform training. Your role is to guide partners through learning SovraGov, a digital window platform for governments.

STUDENT PROFILE:
- Skill Level: ${t.skillLevel}
- Learning Pace: ${t.preferredPace}
- Learning Style: ${t.learningStyle}
- Struggling with: ${n}
- Strong in: ${s}
- Conversations: ${t.conversationCount}

CURRENT CONTEXT:
- Current Topic: ${r||"General SovraGov guidance"}
- Conversation Phase: ${e.conversationPhase}

INSTRUCTIONS:
1. **Match their pace:** Use ${"slow"===t.preferredPace?"detailed explanations with examples":"fast"===t.preferredPace?"concise, direct explanations":"balanced explanations"}.
2. **Match their style:** Use ${"visual"===t.learningStyle?"diagrams and visual descriptions":"interactive"===t.learningStyle?"interactive exercises and tasks":"textual"===t.learningStyle?"detailed text explanations":"a mix of text, examples, and descriptions"}.
3. **Focus on struggles:** Spend extra time on ${n} since they're having trouble.
4. **Build confidence:** Acknowledge what they know well.
5. **Be Socratic:** Ask guiding questions rather than just giving answers.
6. **Provide examples:** Use real SovraGov scenarios (e.g., municipal processes).
7. **Suggest next steps:** After teaching, suggest related tutorials or practice tasks.

SOVRAGOV KEY MODULES:
- Cat\xe1logos: Lists that homogenize data (simple/hierarchical)
- Tr\xe1mites: Digital processes with forms and stages
- Citas: Appointment scheduling with offices/desks
- Pagos: Payment configuration with UTA/concepts
- Inspectores: On-site inspections with verification
- Emisi\xf3n: Document output (PDF/blockchain)

COMMON CONFUSION POINTS:
- Catalogs vs hardcoded dropdown options
- Form sections vs steps (only steps have conditions)
- Prevention rejections vs process rejections
- Simple signatures vs electronic signatures
- UTA (indexed) vs fixed amounts

Always be encouraging, patient, and focused on their learning goals.`}(t),s=[...t.previousMessages.map(e=>({role:e.role,content:e.content})),{role:"user",content:e}],a="";for await(let e of(await S.anthropic.messages.create({model:"claude-3-5-sonnet-20241022",max_tokens:1024,system:n,messages:s,stream:!0})))if("content_block_delta"===e.type&&"text_delta"===e.delta.type){let t=e.delta.text;a+=t,r&&r(t)}return a}async function C(e,t,r){var n,s;let a,i,o=(n=t,s=r,a=`${n} ${s}`.toLowerCase(),["catalogs","catálogos","forms","formulario","stages","etapas","appointments","citas","payments","pagos","inspections","inspectores","emission","emisión","prevention","prevención","users","usuarios","roles","permissions","permisos"].filter(e=>a.includes(e))),l=(i=t.toLowerCase(),["confused","confundido","don't understand","no entiendo","how do i","cómo","why","por qué","error","problem","problema","stuck","atrapado","help","ayuda"].some(e=>i.includes(e))),c={questionsAsked:[...e.questionsAsked||[],t].slice(-20),conversationCount:(e.conversationCount||0)+1};return l?c.strugglingTopics=[...new Set([...e.strugglingTopics,...o])]:c.strongTopics=[...new Set([...e.strongTopics,...o])],c}var R=e.i(31967);async function N(e){try{let{user:t}=await (0,w.requireSession)(),{message:r,conversationId:n,courseId:s,topic:a}=await e.json();if(!r||"string"!=typeof r)return y.NextResponse.json({error:"Message required"},{status:400});let i=n?await (0,x.getTutorConversation)(n):await (0,x.createTutorConversation)(t.id,s);if(!i)return y.NextResponse.json({error:"Conversation not found"},{status:404});let o=await (0,x.getLearningProfile)(t.id);o||(o=await (0,x.createLearningProfile)(t.id));let l=await T(t.id,s,i.messages,o,a),c=new ReadableStream({async start(e){try{let n=await A(r,l,t=>{e.enqueue(new TextEncoder().encode(`data: ${t}

`))}),s={id:(0,R.generateId)(),role:"user",content:r,timestamp:new Date().toISOString()},a={id:(0,R.generateId)(),role:"assistant",content:n,timestamp:new Date().toISOString()};await (0,x.addMessageToConversation)(i.id,s),await (0,x.addMessageToConversation)(i.id,a);let c=await C(o,r,n);await (0,x.updateLearningProfile)(t.id,c),e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify({type:"done",conversationId:i.id})}

`)),e.close()}catch(t){console.error("Tutor stream error:",t),e.enqueue(new TextEncoder().encode(`data: ${JSON.stringify({error:String(t)})}

`)),e.close()}}});return new y.NextResponse(c,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}catch(e){return console.error("Tutor chat error:",e),y.NextResponse.json({error:"Failed to process message"},{status:500})}}e.s(["POST",()=>N],67231);var O=e.i(67231);let P=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/partners/tutor/chat/route",pathname:"/api/partners/tutor/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/partners-portal/src/app/api/partners/tutor/chat/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:E,workUnitAsyncStorage:k,serverHooks:b}=P;function q(){return(0,n.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:k})}async function $(e,t,n){P.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/partners/tutor/chat/route";y=y.replace(/\/index$/,"")||"/";let w=await P.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:x,params:S,nextConfig:T,parsedUrl:A,isDraftMode:C,prerenderManifest:R,routerServerContext:N,isOnDemandRevalidate:O,revalidateOnlyGenerated:E,resolvedPathname:k,clientReferenceManifest:b,serverActionsManifest:q}=w,$=(0,o.normalizeAppPath)(y),I=!!(R.dynamicRoutes[$]||R.routes[k]),_=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,A,!1):t.end("This page could not be found"),null);if(I&&!C){let e=!!R.routes[k],t=R.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await _();throw new v.NoFallbackError}}let D=null;!I||P.isDev||C||(D="/index"===(D=k)?"/":D);let M=!0===P.isDev||!I,U=I&&!M;q&&b&&(0,i.setManifestsSingleton)({page:y,clientReferenceManifest:b,serverActionsManifest:q});let j=e.method||"GET",L=(0,a.getTracer)(),J=L.getActiveScopeSpan(),H={params:S,prerenderManifest:R,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,s)=>P.onRequestError(e,t,n,s,N)},sharedContext:{buildId:x}},F=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let i=async e=>P.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${y}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var a,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&O&&E&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=H.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(F,G,a,H.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,n=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})},!1,N),t}},d=await P.handleResponse({req:e,nextConfig:T,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:R,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:E,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:o});if(!I)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&I||v.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(F,G,new Response(d.value.body,{headers:v,status:d.value.status||200})),null};J?await l(J):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${y}`,kind:a.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})},!1,N),I)throw t;return await (0,p.sendResponse)(F,G,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>q,"routeModule",()=>P,"serverHooks",()=>b,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>k],76153)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__42f79d86._.js.map