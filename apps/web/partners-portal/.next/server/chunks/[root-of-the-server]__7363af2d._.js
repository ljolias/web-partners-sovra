module.exports=[66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},4287,e=>{"use strict";e.i(89161),e.i(81769),e.i(31967),e.s([])},68320,47665,74412,e=>{"use strict";var t=e.i(89161),r=e.i(81769);let n={COPILOT_SESSION_COMPLETED:2,TRAINING_MODULE_COMPLETED:3,CERTIFICATION_EARNED:10,DEAL_CLOSED_WON:15,MEDDIC_SCORE_IMPROVED:1,DEAL_CLOSED_LOST_POOR_QUALIFICATION:-10,CERTIFICATION_EXPIRED:-5,LEGAL_EXPIRED:-8,DEAL_STALE_30_DAYS:-3,LOGIN_INACTIVE_30_DAYS:-2};async function a(e,a,i,o){let s={id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,partnerId:e,userId:a,eventType:i,points:n[i],metadata:o,createdAt:new Date().toISOString()};return await t.redis.zadd(r.keys.ratingEvents(e),{score:new Date(s.createdAt).getTime(),member:JSON.stringify(s)}),s}async function i(e,n,a){return(await t.redis.zrange(r.keys.ratingEvents(e),n.getTime(),a.getTime(),{byScore:!0})).map(e=>"string"==typeof e?JSON.parse(e):e)}async function o(e){await t.redis.set(r.keys.partnerLastLogin(e),new Date().toISOString())}e.s(["getPartnerEventsInRange",()=>i,"logRatingEvent",()=>a,"updatePartnerLastLogin",()=>o],47665);var s=e.i(31967);let l=[{tier:"platinum",minScore:90},{tier:"gold",minScore:70},{tier:"silver",minScore:50},{tier:"bronze",minScore:0}];async function d(e,t){let r=new Date,n=new Date(r.getTime()-2592e6),a=await i(e,n,r);return Math.max(0,Math.min(100,50+Math.min(5*a.filter(e=>"COPILOT_SESSION_COMPLETED"===e.eventType).length,25)+Math.min(10*a.filter(e=>"TRAINING_MODULE_COMPLETED"===e.eventType).length,20)-10*a.filter(e=>"LOGIN_INACTIVE_30_DAYS"===e.eventType).length))}async function c(e,t){let[r,n]=await Promise.all([(0,s.getAllLegalDocuments)(),(0,s.getUserSignatures)(t)]),a=r.filter(e=>e.requiredForDeals);if(0===a.length)return 100;let i=new Set(n.map(e=>e.documentId));return a.filter(e=>i.has(e.id)).length/a.length*100}async function u(e,t){let r,n,[a,i]=await Promise.all([(0,s.getPartnerDeals)(e),(0,s.getUserCertifications)(t)]),[o,u]=await Promise.all([d(e,t),c(e,t)]),p={dealQuality:function(e){if(0===e.length)return 50;let t=e.filter(e=>["approved","closed_won","closed_lost"].includes(e.status)),r=e.length>0?t.length/e.length:0,n=e.filter(e=>["closed_won","closed_lost"].includes(e.status)),a=n.filter(e=>"closed_won"===e.status),i=n.length>0?a.length/n.length:0,o=e.filter(e=>e.partnerGeneratedLead).length;return 40*r+40*i+20*(e.length>0?o/e.length:0)}(a),engagement:o,certification:(r=new Date,0===(n=i.filter(e=>"active"===e.status&&new Date(e.expiresAt)>r)).length?20:1===n.length?60:2===n.length?80:100),compliance:u,revenue:function(e){let t=e.filter(e=>"closed_won"===e.status);if(0===t.length)return 30;let r=Math.min(15*t.length,70),n=t.reduce((e,t)=>e+t.population,0)/t.length;return n>=1e6?r+=30:n>=5e5?r+=20:n>=1e5&&(r+=10),Math.min(100,r)}(a)},g=Math.round(.3*p.dealQuality+.25*p.engagement+.2*p.certification+.15*p.compliance+.1*p.revenue);return{partnerId:e,totalScore:g,tier:function(e){for(let t of l)if(e>=t.minScore)return t.tier;return"bronze"}(g),factors:p,calculatedAt:new Date().toISOString()}}async function p(e,n){let a=await u(e,n);await t.redis.set(r.keys.ratingCalculation(e),JSON.stringify(a));let i=await (0,s.getPartner)(e);return i&&i.tier!==a.tier?await (0,s.updatePartner)(e,{tier:a.tier,rating:a.totalScore}):i&&await (0,s.updatePartner)(e,{rating:a.totalScore}),a}e.s(["recalculateAndUpdatePartner",()=>p],74412),e.s([],68320)},61169,e=>{"use strict";var t=e.i(72305),r=e.i(89013),n=e.i(88387),a=e.i(77950),i=e.i(30739),o=e.i(43703),s=e.i(58601),l=e.i(59251),d=e.i(12242),c=e.i(6002),u=e.i(92234),p=e.i(45043),g=e.i(18348),h=e.i(85936),f=e.i(72254),w=e.i(93695);e.i(24887);var m=e.i(42277);e.i(21534);var y=e.i(52945);e.i(4287);var E=e.i(31967);e.i(70414);var R=e.i(26783),S=e.i(73249);e.i(68320);var v=e.i(47665),x=e.i(74412);async function C(e){try{let{user:t,partner:r}=await (0,y.requireSession)(),{sessionId:n,dealId:a,message:i}=await e.json();if(!a||!i)return new Response(JSON.stringify({error:"Deal ID and message are required"}),{status:400,headers:{"Content-Type":"application/json"}});let o=await (0,E.getDeal)(a);if(!o)return new Response(JSON.stringify({error:"Deal not found"}),{status:404,headers:{"Content-Type":"application/json"}});if(o.partnerId!==r.id)return new Response(JSON.stringify({error:"Access denied"}),{status:403,headers:{"Content-Type":"application/json"}});if(!R.anthropic)return new Response(JSON.stringify({error:"Copilot is not available"}),{status:503,headers:{"Content-Type":"application/json"}});let s=null;n&&(s=await (0,E.getCopilotSession)(n));let l=s?await (0,E.getCopilotMessages)(s.id):[],d={id:`msg-${Date.now()}`,role:"user",content:i,createdAt:new Date().toISOString()};s&&await (0,E.addCopilotMessage)(s.id,d);let c=(e.headers.get("accept-language")||"es").split(",")[0].split("-")[0],u=(0,S.buildSystemPrompt)(o,c),p=[...l.map(e=>({role:e.role,content:e.content})),{role:"user",content:i}],g=new TextEncoder,h=new ReadableStream({async start(e){try{let n=await R.anthropic.messages.create({model:R.MODEL,max_tokens:1024,system:u,messages:p,stream:!0}),i="";for await(let t of n)if("content_block_delta"===t.type&&"text_delta"===t.delta.type){let r=t.delta.text;i+=r;let n=JSON.stringify({content:r});e.enqueue(g.encode(`data: ${n}

`))}let o=(0,S.parseScoreSuggestions)(i),l=(0,S.cleanResponseContent)(i),d={id:`msg-${Date.now()+1}`,role:"assistant",content:l,suggestedScores:Object.keys(o).length>0?o:void 0,createdAt:new Date().toISOString()};if(s&&(await (0,E.addCopilotMessage)(s.id,d),Object.keys(o).length>0&&await (0,E.updateCopilotMeddic)(s.id,o)),Object.keys(o).length>0){let t=JSON.stringify({suggestedScores:o});e.enqueue(g.encode(`data: ${t}

`))}await (0,v.logRatingEvent)(r.id,t.id,"COPILOT_SESSION_COMPLETED",{dealId:a,sessionId:s?.id}),(0,x.recalculateAndUpdatePartner)(r.id,t.id).catch(console.error),e.enqueue(g.encode("data: [DONE]\n\n")),e.close()}catch(r){console.error("Streaming error:",r);let t=JSON.stringify({error:"Streaming failed"});e.enqueue(g.encode(`data: ${t}

`)),e.close()}}});return new Response(h,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}catch(e){if(e instanceof Error&&"Unauthorized"===e.message)return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});return console.error("Copilot chat error:",e),new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}})}}e.s(["POST",()=>C],65763);var O=e.i(65763);let _=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/partners/copilot/chat/route",pathname:"/api/partners/copilot/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/partners-portal/src/app/api/partners/copilot/chat/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:T,workUnitAsyncStorage:A,serverHooks:D}=_;function I(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:A})}async function N(e,t,n){_.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/partners/copilot/chat/route";y=y.replace(/\/index$/,"")||"/";let E=await _.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:S,nextConfig:v,parsedUrl:x,isDraftMode:C,prerenderManifest:O,routerServerContext:T,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,resolvedPathname:I,clientReferenceManifest:N,serverActionsManifest:P}=E,b=(0,s.normalizeAppPath)(y),L=!!(O.dynamicRoutes[b]||O.routes[I]),M=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,x,!1):t.end("This page could not be found"),null);if(L&&!C){let e=!!O.routes[I],t=O.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await M();throw new w.NoFallbackError}}let k=null;!L||_.isDev||C||(k="/index"===(k=I)?"/":k);let q=!0===_.isDev||!L,j=L&&!q;P&&N&&(0,o.setManifestsSingleton)({page:y,clientReferenceManifest:N,serverActionsManifest:P});let U=e.method||"GET",H=(0,i.getTracer)(),$=H.getActiveScopeSpan(),F={params:S,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>_.onRequestError(e,t,n,a,T)},sharedContext:{buildId:R}},J=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(J,(0,d.signalFromNodeResponse)(t));try{let o=async e=>_.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${y}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&A&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!L)return await (0,p.sendResponse)(J,G,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})},!1,T),t}},c=await _.handleResponse({req:e,nextConfig:v,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:s});if(!L)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&L||w.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(J,G,new Response(c.value.body,{headers:w,status:c.value.status||200})),null};$?await l($):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})},!1,T),L)throw t;return await (0,p.sendResponse)(J,G,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>I,"routeModule",()=>_,"serverHooks",()=>D,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>A],61169)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__7363af2d._.js.map